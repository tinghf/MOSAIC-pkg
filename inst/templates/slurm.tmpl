#!/bin/bash

## SLURM batch job template for MOSAIC calibration
## Generated by future.batchtools
##
## Job name and identifiers
#SBATCH --job-name=<%= job.name %>
#SBATCH --output=<%= log.file %>
#SBATCH --error=<%= log.file %>

## Resource requirements
#SBATCH --nodes=<%= resources$nodes %>
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=<%= resources$cpus %>
#SBATCH --mem=<%= resources$memory %>
#SBATCH --time=<%= resources$walltime %>

<% if (!is.null(resources$partition)) { %>
#SBATCH --partition=<%= resources$partition %>
<% } %>

<% if (!is.null(resources$account)) { %>
#SBATCH --account=<%= resources$account %>
<% } %>

## Optional: Email notifications
## #SBATCH --mail-type=END,FAIL
## #SBATCH --mail-user=your.email@institution.edu

## ========================================================================
## Environment Setup
## ========================================================================

## Load modules (if needed on your cluster)
## module purge
## module load R/4.3.0
## module load gdal/3.6.0
## module load geos/3.11.0

## Activate conda environment for Python dependencies
## If using system Python, comment this out
if [ -f "$HOME/miniforge3/etc/profile.d/conda.sh" ]; then
    source "$HOME/miniforge3/etc/profile.d/conda.sh"
    conda activate mosaic-conda-env
elif [ -f "$HOME/miniconda3/etc/profile.d/conda.sh" ]; then
    source "$HOME/miniconda3/etc/profile.d/conda.sh"
    conda activate mosaic-conda-env
fi

## Set R library path (for user-installed packages)
export R_LIBS_USER="$HOME/R/library"

## ========================================================================
## Threading Configuration
## ========================================================================
## CRITICAL: Limit threading to prevent oversubscription
## Each MOSAIC worker should use single-threaded operations
## This prevents 100 workers Ã— 8 BLAS threads = 800 threads (severe slowdown)

export OMP_NUM_THREADS=1
export MKL_NUM_THREADS=1
export NUMBA_NUM_THREADS=1
export TBB_NUM_THREADS=1
export OPENBLAS_NUM_THREADS=1
export BLIS_NUM_THREADS=1
export R_DATATABLE_NUM_THREADS=1

## Prevent OpenMP dynamic thread adjustment
export OMP_DYNAMIC=FALSE

## ========================================================================
## Job Execution
## ========================================================================

## Print job information
echo "=================================================================="
echo "MOSAIC BFRS Calibration - Slurm Job"
echo "=================================================================="
echo "Job ID: $SLURM_JOB_ID"
echo "Job name: $SLURM_JOB_NAME"
echo "Node: $SLURM_NODELIST"
echo "CPUs: $SLURM_CPUS_PER_TASK"
echo "Memory: <%= resources$memory %>"
echo "Start time: $(date)"
echo "=================================================================="
echo ""

## Change to submission directory (where R was launched)
cd <%= getwd() %>

## Run batchtools job collection
## This executes the specific task assigned to this worker
Rscript -e 'batchtools::doJobCollection("<%= uri %>")'

EXIT_CODE=$?

## Print completion information
echo ""
echo "=================================================================="
echo "Job completed with exit code: $EXIT_CODE"
echo "End time: $(date)"
echo "=================================================================="

exit $EXIT_CODE
