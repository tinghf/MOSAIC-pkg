#!/bin/bash

## SLURM batch job template for MOSAIC calibration (CONTAINER VERSION)
## Uses Singularity/Apptainer container image
## Generated by future.batchtools
##
## Job name and identifiers
#SBATCH --job-name=<%= job.name %>
#SBATCH --output=<%= log.file %>
#SBATCH --error=<%= log.file %>

## Resource requirements
#SBATCH --nodes=<%= resources$nodes %>
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=<%= resources$cpus %>
#SBATCH --mem=<%= resources$memory %>
#SBATCH --time=<%= resources$walltime %>

<% if (!is.null(resources$partition)) { %>
#SBATCH --partition=<%= resources$partition %>
<% } %>

<% if (!is.null(resources$account)) { %>
#SBATCH --account=<%= resources$account %>
<% } %>

## Optional: Email notifications
## #SBATCH --mail-type=END,FAIL
## #SBATCH --mail-user=your.email@institution.edu

## ========================================================================
## Environment Setup
## ========================================================================

## Load Singularity/Apptainer module (if needed on your cluster)
## module load singularity/3.11.0
## OR
## module load apptainer/1.2.0

## Set container image path
## USER MUST SET THIS: Path to MOSAIC container image
<% if (!is.null(resources$container_image)) { %>
MOSAIC_CONTAINER="<%= resources$container_image %>"
<% } else { %>
## Default location - UPDATE THIS FOR YOUR CLUSTER
MOSAIC_CONTAINER="${HOME}/containers/mosaic_latest.sif"
<% } %>

## Verify container exists
if [ ! -f "$MOSAIC_CONTAINER" ]; then
    echo "ERROR: Container image not found at: $MOSAIC_CONTAINER"
    echo "Please build container or update resources\$container_image path"
    exit 1
fi

## Bind mounts for data and output directories
## This makes host directories accessible inside container
BIND_MOUNTS="<%= getwd() %>:<%= getwd() %>"

## Optional: Add scratch or project directories
## BIND_MOUNTS="${BIND_MOUNTS},/scratch/${USER}:/scratch/${USER}"
## BIND_MOUNTS="${BIND_MOUNTS},/projects/myproject:/projects/myproject"

## ========================================================================
## Job Execution
## ========================================================================

## Print job information
echo "=================================================================="
echo "MOSAIC BFRS Calibration - Slurm Job (Container)"
echo "=================================================================="
echo "Job ID: $SLURM_JOB_ID"
echo "Job name: $SLURM_JOB_NAME"
echo "Node: $SLURM_NODELIST"
echo "CPUs: $SLURM_CPUS_PER_TASK"
echo "Memory: <%= resources$memory %>"
echo "Container: $(basename $MOSAIC_CONTAINER)"
echo "Start time: $(date)"
echo "=================================================================="
echo ""

## Change to submission directory
cd <%= getwd() %>

## Run batchtools job collection inside container
## singularity exec: Execute command in container
## --cleanenv: Start with clean environment (prevents conflicts)
## --bind: Mount host directories
singularity exec \
    --cleanenv \
    --bind "$BIND_MOUNTS" \
    "$MOSAIC_CONTAINER" \
    Rscript -e 'batchtools::doJobCollection("<%= uri %>")'

EXIT_CODE=$?

## Print completion information
echo ""
echo "=================================================================="
echo "Job completed with exit code: $EXIT_CODE"
echo "End time: $(date)"
echo "=================================================================="

exit $EXIT_CODE
