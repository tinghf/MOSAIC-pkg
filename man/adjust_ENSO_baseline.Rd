% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/adjust_ENSO_baseline.R
\name{adjust_ENSO_baseline}
\alias{adjust_ENSO_baseline}
\title{Simple Bias Correction for ENSO Data with Different Climatological Baselines}
\usage{
adjust_ENSO_baseline(historical, forecast, n_overlap = NULL)
}
\arguments{
\item{historical}{Numeric vector of historical observations (degrees Celsius).
Use NA for future periods without observations.}

\item{forecast}{Numeric vector of forecast values (degrees Celsius), same
length as historical. Use NA for periods without forecasts.}

\item{n_overlap}{Integer number of timesteps from end of overlap period to
use for bias calculation. If NULL or Inf, uses all available overlap points.
Default: NULL (all overlap).}
}
\value{
A list containing:
\item{historical}{Original historical observations vector.}
\item{forecast}{Original forecast vector.}
\item{forecast_corrected}{Bias-corrected forecast vector (forecast - bias).}
\item{combined}{Combined time series: historical takes priority, then corrected forecast.}
\item{bias}{Estimated mean bias (degrees Celsius) calculated as mean(forecast - historical).}
\item{se}{Standard error of the bias estimate.}
\item{n_overlap}{Number of overlap points used for bias calculation.}
\item{differences}{Raw differences (forecast - historical) during overlap period used for bias estimation.}
}
\description{
Harmonizes ENSO forecast data from different sources (BOM, IRI) to NOAA's
1991-2020 baseline by estimating and removing systematic bias during an
overlap period where both historical observations and archived forecasts exist.
}
\details{
Three ENSO data sources use different climatological baselines, creating
systematic offsets of 0.1-0.3°C:
\itemize{
\item NOAA Historical: 1991-2020 baseline (reference)
\item BOM Forecasts: 1981-2010 baseline (typically +0.15 to +0.25°C warmer)
\item IRI Ensemble: Mixed baselines (typically +0.20 to +0.30°C warmer)
}

The function estimates bias as the mean difference during the overlap period
and subtracts it from forecast values to harmonize them to NOAA's baseline.
A minimum of 12 months overlap is recommended to capture seasonal cycles.

For IRI data, ensure values are converted to degrees Celsius (divide by 100)
before passing to this function, as IRI stores values in hundredths.
}
\examples{
\dontrun{
# Example 1: BOM forecast with 3-month overlap
# Historical NOAA observations (months 1-12, then NA for future)
historical <- c(-0.5, -0.6, -0.7, -0.8, -0.7, -0.6,
                -0.5, -0.4, -0.3, -0.2, -0.1, 0.0,
                rep(NA, 12))

# BOM forecasts (NA for months 1-9, overlap 10-12, future 13-24)
forecast <- c(rep(NA, 9),
              -0.2, 0.0, 0.2,  # Overlap period
              0.3, 0.4, 0.5, 0.6, 0.7, 0.8,
              0.9, 1.0, 1.1, 1.2, 1.3, 1.4)  # Future

# Apply bias correction using all overlap points
result <- adjust_ENSO_baseline(historical, forecast, n_overlap = NULL)

print(result$bias)           # Expected: ~0.2°C
print(result$n_overlap)      # 3 overlap points used
print(result$combined[13:15]) # Corrected future forecasts


# Example 2: IRI forecast with unit conversion and 12-month overlap
# Historical NOAA observations
historical <- c(-0.5, -0.6, -0.7, -0.8, -0.7, -0.6,
                -0.5, -0.4, -0.3, -0.2, -0.1, 0.0,
                rep(NA, 12))

# IRI forecasts - RAW values in hundredths (must convert!)
forecast_raw <- c(-28, -38, -47, -58, -48, -37,
                  -26, -16, -8, 3, 14, 23,    # Overlap period (months 1-12)
                  67, 72, 68, 55, 38, 22,
                  10, 5, 2, -5, -8, -10)      # Future (months 13-24)

# Convert IRI to degrees Celsius
forecast <- forecast_raw / 100

# Apply bias correction using last 6 months only
result <- adjust_ENSO_baseline(historical, forecast, n_overlap = 6)

print(result$bias)            # Expected: ~0.23°C
print(result$se)              # Standard error
print(result$n_overlap)       # 6 (months 7-12)

# Examine bias distribution
hist(result$differences,
     main = "Bias Distribution",
     xlab = "Difference (°C)",
     col = "lightblue")
abline(v = result$bias, col = "red", lwd = 2, lty = 2)


# Example 3: Time Series Visualization with Residuals
# Create realistic example with dates
dates <- seq(as.Date("2024-01-01"), as.Date("2025-12-01"), by = "month")
n <- length(dates)

# Historical observations (18 months) then NA
historical <- c(rnorm(18, mean = -0.3, sd = 0.3), rep(NA, n - 18))

# Forecast available for last 12 months (overlaps last 6 months of historical)
forecast <- c(rep(NA, 12),
              rnorm(12, mean = -0.1, sd = 0.3))  # Warmer by ~0.2°C (baseline bias)

# Apply bias correction
result <- adjust_ENSO_baseline(historical, forecast, n_overlap = 6)

# Create two-panel plot
par(mfrow = c(2, 1), mar = c(3, 4, 2, 1), oma = c(2, 0, 1, 0))

# Panel 1: Time series with historical, raw forecast, and corrected forecast
plot(dates, historical, type = "l", col = "black", lwd = 2,
     ylim = range(c(historical, forecast, result$forecast_corrected), na.rm = TRUE),
     xlab = "", ylab = "ENSO Anomaly (°C)",
     main = "ENSO Baseline Adjustment",
     las = 1)
grid()

# Add raw forecast (dashed, red)
lines(dates, forecast, col = "red", lwd = 2, lty = 2)

# Add corrected forecast (solid, blue)
lines(dates, result$forecast_corrected, col = "blue", lwd = 2, lty = 1)

# Add vertical line at transition point
transition_idx <- max(which(!is.na(historical)))
abline(v = dates[transition_idx], col = "gray50", lty = 3, lwd = 1)

# Add horizontal line at zero
abline(h = 0, col = "gray70", lty = 1, lwd = 0.5)

# Add ENSO thresholds
abline(h = c(-0.5, 0.5), col = "gray50", lty = 2, lwd = 0.5)
text(dates[2], 0.5, "El Niño", pos = 3, cex = 0.7, col = "gray50")
text(dates[2], -0.5, "La Niña", pos = 1, cex = 0.7, col = "gray50")

# Legend
legend("topleft",
       legend = c("Historical (NOAA)",
                  "Raw Forecast (BOM)",
                  sprintf("Corrected (bias = \%.2f°C)", result$bias)),
       col = c("black", "red", "blue"),
       lty = c(1, 2, 1),
       lwd = 2,
       bty = "n",
       cex = 0.8)

# Panel 2: Residuals (forecast - historical during overlap)
# Create residual vector for all dates
residuals <- forecast - historical

plot(dates, residuals, type = "h", col = "red", lwd = 2,
     ylim = range(residuals, na.rm = TRUE) * 1.2,
     xlab = "Date", ylab = "Bias (°C)",
     main = sprintf("Forecast Bias (n=\%d overlap months)", result$n_overlap),
     las = 1)
grid()

# Add points at overlap period
overlap_idx <- which(!is.na(historical) & !is.na(forecast))
points(dates[overlap_idx], residuals[overlap_idx],
       col = "red", pch = 19, cex = 1.2)

# Add horizontal lines
abline(h = 0, col = "gray70", lwd = 1)
abline(h = result$bias, col = "blue", lwd = 2, lty = 2)

# Add confidence interval (±2 SE)
if (!is.na(result$se) && result$se > 0) {
  abline(h = result$bias + c(-2, 2) * result$se,
         col = "blue", lwd = 1, lty = 3)
}

# Add text annotation
text(dates[n * 0.8], result$bias,
     sprintf("Mean bias = \%.3f ± \%.3f°C", result$bias, result$se),
     pos = 3, col = "blue", cex = 0.8)

# Reset graphics parameters
par(mfrow = c(1, 1), mar = c(5, 4, 4, 2) + 0.1, oma = c(0, 0, 0, 0))
}

}
